@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Buttons
@using System.Globalization
@using System.Text
@inject NavigationManager NavigationManager

@*Initialize the TreeView component*@

@using global::Blazorise.TreeView

<TreeView Nodes="@TreeDataSource"
          GetChildNodes="@(item => item.Child)"
          HasChildNodes="@(item => item.Child?.Any() == true)"
          SelectedNodeChange="sele">
    <NodeContent>
        <Icon Name="IconName.Folder" />
        @context.NodeText
    </NodeContent>
</TreeView>

@* <SfTreeView TValue="TreeItem" SelectedNodesChanged="NodeSelected"> *@
@*     <TreeViewFieldsSettings DataSource="@TreeDataSource" *@
@*                             Id="NodeId" Text="NodeText" Expanded="Expanded" *@
@*                             TValue="TreeItem" *@
@*                             NavigateUrl="Url" *@
@*                             Child="@("Child")"  > *@
@*     </TreeViewFieldsSettings> *@
@* </SfTreeView> *@

@code{

    // Specifies the DataSource value for TreeView component.
    List<TreeItem> TreeDataSource = new List<TreeItem>();

    protected override void OnInitialized()
    {
        base.OnInitialized();
        TreeDataSource.Add(new TreeItem()
        {
            NodeId = "1",
            NodeText = "1 - Introduction",
            Icon = "folder",
            Expanded = false,
            Child = new List<TreeItem>()
            {
                new TreeItem { NodeId = "1-00", NodeText = "Counter Example", Url = "/counter", Code = "Counter.razor", Icon = "html" },
                new TreeItem { NodeId = "1-01", NodeText = "Razor Syntax", Url = "/razor-syntax",  Code = "RazorSyntax.razor", Icon = "html" },
                new TreeItem { NodeId = "1-02", NodeText = "Data Binding", Icon = "html", 
                    Child = new List<TreeItem>()
                    {
                        new TreeItem() { NodeId = "1-02-01", NodeText = "One way", Url = "/data-binding/one-way", Icon = "html"},
                        new TreeItem() { NodeId = "1-02-02", NodeText = "Two way", Url = "/data-binding/two-way", Icon = "html"},
                        
                        new () { NodeId = "1-02-03", NodeText = "Object", Url = "/data-binding/object", Icon = "html"},
                        
                        new TreeItem() { NodeId = "1-02-04", NodeText = "Get Set", Url = "/data-binding/get-set", Icon = "html"},
                        new TreeItem() { NodeId = "1-02-05", NodeText = "Get After", Url = "/data-binding/bind-after", Icon = "html"},
                    }
                },
                new TreeItem() { NodeId = "1-03", NodeText = "Events", Url = "/events", Icon = "html" },
                new TreeItem { NodeId = "1-04", NodeText = "Simple Todo Example", Url = "/todo", Icon = "html" },
            }
        });
        TreeDataSource.Add(new TreeItem()
        {
            NodeId = "2",
            NodeText = "2 - Components Basics",
            Icon = "folder",
            Expanded = false,
            Child = new List<TreeItem>()
            {
                new TreeItem()
                {
                    NodeId = "2-01", NodeText = "Construction", Icon = "folder",
                    Child = new List<TreeItem>()
                    {
                        new TreeItem() { NodeId = "2-01-01", NodeText = "Simple Component", Url = "/simple-component-example", Icon = "html" },
                        new TreeItem() { NodeId = "2-01-02", NodeText = "Partial Component", Url = "/simple-component-example-partial", Icon = "html" },
                        new TreeItem() { NodeId = "2-01-03", NodeText = "Inheritance Component", Url = "/simple-component-example-inheritance", Icon = "html" }
                    }
                },
                new TreeItem()
                {
                    NodeId = "2-02", NodeText = "Parameters", Icon = "folder",
                    Child = new List<TreeItem>()
                    {
                        new TreeItem()
                        {
                            NodeId = "2-02-01", NodeText = "Component Parameter", Url = "/component-parameter", Icon = "html"
                        },
                        new TreeItem()
                        {
                            NodeId = "2-02-02", NodeText = "Component Chained Binding", Url = "/component-with-chained-binding", Icon = "html"
                        }
                    }
                },
                new TreeItem()
                {
                    NodeId  = "2-03", NodeText = "Event Callback", Url = "/component-events", Icon = "html",
                },
                new TreeItem()
                {
                    NodeId = "2-04", NodeText = "State management", Icon = "folder",
                    Child = new List<TreeItem>()
                    {
                        new TreeItem()
                        {
                            NodeId = "2-04-1", NodeText = "Component State", Url = "counter-component-state", Icon = "html"
                        },
                        new TreeItem()
                        {
                            NodeId = "2-04-2", NodeText = "Counter State Static (don't)", Url = "/counter-state-static-variable", Icon = "html"
                        },
                        new TreeItem()
                        {
                            NodeId = "2-04-3", NodeText = "Cascade Parameters", Url = "/counter-cascade-state", Icon = "html"
                        }
                    }
                },
                new TreeItem()
                { NodeId = "2-05", NodeText = "Todo Example", Url = "/todo-list", Icon = "html" },
                
                
            }
        });

        TreeDataSource.Add(new TreeItem()
        {
            NodeId = "3",
            NodeText = "3 - Databases",
            Icon = "folder",
            Expanded = false,
            Child = [
                new () { NodeId = "3-01", NodeText = "Todo list db", Url = "/todo-list-db", Icon = "html" },
                new () { NodeId = "3-02", NodeText = "Bier", Url = "/bier", Icon = "html" },
                new () { NodeId = "3-03", NodeText = "Brouwer", Url = "/brouwer", Icon = "html" }
                
            ]
        });
        
        TreeDataSource.Add(new ()
        {
            NodeId = "4",
            NodeText = "4 - Forms & Generic Components",
            Icon = "folder",
            Expanded = false,
            Child = [
                new () { NodeId = "4-01", NodeText = "Form + Validation", Url = "forms/add-bier", Icon = "html" },
                new () { NodeId = "4-02", NodeText = "Fluent Validation", Url = "forms/add-bier-fluent", Icon = "html" },
                new () { NodeId = "4-03", NodeText = "Render Fragments", Url = "/render-fragments", Icon = "html"},
                new () { NodeId = "4-04", NodeText = "Generic Data table", Url = "/generic-data-table", Icon = "html"}
            ]
        });
        
        TreeDataSource.Add(new ()
        {
            NodeId = "5",
            NodeText = "5 UI Library - Blazorise",
            Icon = "folder",
            Expanded = false,
            Child = [
                new TreeItem() { NodeId = "5-01", NodeText = "Datagrid", Url = "/blazorise-datagrid", Icon = "html"}
            ]
        });
        TreeDataSource.Add(new TreeItem()
        {
            NodeId = "6",
            NodeText = "Service for State Management (advanced)",
            Icon = "folder",
            Expanded = false,
            Child = [
                new TreeItem() { NodeId = "6-01", NodeText = "State Management Service with Notification", Url = "/counter-state-service", Icon = "html"},
                new TreeItem() { NodeId = "6-02", NodeText = "State Management Service multiple components (Todo)", Url = "/todo-state-service", Icon = "html"},
                new TreeItem() { NodeId = "6-03", NodeText = "State Management Service with Fluxor (Todo)", Url = "/todo-state-fluxor", Icon = "html"}
            ]
        });
        
        // TreeDataSource.ForEach(x => x.Url = $"/code-viewer?code-url={x.Code} page-url={x.Url}");
        TreeDataSource.ForEach(UpdateTreeWidthCode);
    }
    
    public void UpdateTreeWidthCode(TreeItem treeItem)
    {
        if (treeItem.Url != null && treeItem.Url.StartsWith("/"))
        {
            treeItem.Url = treeItem.Url.Substring(1);
        }
        
        if (treeItem.Code != null)
        {
            var treeUrl = treeItem.Url;
            
            
            treeItem.Url = $"/code-viewer?code-url={treeItem.Code}&page-url={treeUrl}";
        }
        else if(treeItem.Code == null && treeItem.Url != null)
        {
            var treeUrl = treeItem.Url;
            treeItem.Code = $"{FirstCharToUpper(Capitalise(treeUrl, "-", CultureInfo.InvariantCulture)).Replace("-", "")}.razor";
            
            treeItem.Url = $"/code-viewer?code-url={treeItem.Code}&page-url={treeUrl}";
        }
        
        

        
        
        foreach (var child in treeItem.Child)
        {
            UpdateTreeWidthCode(child);    
        }
    }
    
    public static string FirstCharToUpper(string input) =>
        input switch
        {
            null => throw new ArgumentNullException(nameof(input)),
            "" => throw new ArgumentException($"{nameof(input)} cannot be empty", nameof(input)),
            _ => string.Concat(input[0].ToString().ToUpper(), input.AsSpan(1))
        };
    
    public static string Capitalise(string text, string targets, CultureInfo culture)
    {
        bool capitalise = true;
        var result = new StringBuilder(text.Length);

        foreach (char c in text)
        {
            if (capitalise)
            {
                result.Append(char.ToUpper(c, culture));
                capitalise = false;
            }
            else
            {
                if (targets.Contains(c))
                    capitalise = true;

                result.Append(c);
            }
        }

        return result.ToString();
    }

    public class TreeItem
    {
        public string NodeId { get; set; } = null!;
        public string NodeText { get; set; } = null!;
        public string Icon { get; set; } = "folder";
        public bool Expanded { get; set; }
        public bool Selected { get; set; }
        public List<TreeItem> Child { get; set; } = new List<TreeItem>();
        public string? ImageUrl { get; set; }
        public string? Url { get; set; }
        public string? Code { get; set; }
    }
    
    private void NodeClicked(NodeClickEventArgs obj)
    {
        if (obj.NodeData != null)
        {
            Console.WriteLine(obj.ToString());
        }
    }

    private void NodeSelected(NodeSelectEventArgs obj)
    {
        obj.NodeData.Id = "selected";
    }

    private void NodeSelected(string[] obj)
    {
        
    }

}